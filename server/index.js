const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const dotenv = require('dotenv');

// Load .env BEFORE route imports so SMTP_* vars are available during transporter init
dotenv.config();

const usersRoutes = require('./routes/users');
const productsRoutes = require('./routes/products');
const categoriesRoutes = require('./routes/categories');
const ordersRoutes = require('./routes/orders');
const notificationsRoutes = require('./routes/notifications');
const analyticsRoutes = require('./routes/analytics');

const app = express();

app.use(cors());
app.use(express.json());

app.get('/api/v1/health', (_req, res) => {
  res.status(200).json({ status: 'ok' });
});

app.use('/api/v1/users', usersRoutes);
app.use('/api/v1/products', productsRoutes);
app.use('/api/v1/categories', categoriesRoutes);
app.use('/api/v1/orders', ordersRoutes);
app.use('/api/v1/notifications', notificationsRoutes);
app.use('/api/v1/analytics', analyticsRoutes);

const start = async () => {
  try {
    await mongoose.connect(process.env.MONGODB_URI, {
      autoIndex: true
    });
    console.log('✓ MongoDB connected successfully');

    const port = process.env.PORT || 4000;
    app.listen(port, '0.0.0.0', () => {
      console.log(`✓ API running on http://0.0.0.0:${port}`);
      console.log(`✓ Access from mobile: http://192.168.1.2:${port}`);
    });
  } catch (err) {
    console.error('✗ Failed to start API:', err);
    process.exit(1);
  }
};

start();
